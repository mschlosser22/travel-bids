# Stripe Webhook Integration - Testing Session

## What We've Done

### 1. Deployed Stripe Webhook Integration ✅
- Created webhook handler at `/app/api/webhooks/stripe/route.ts`
- Handles these events:
  - `checkout.session.completed` - Updates booking to "confirmed"
  - `checkout.session.expired` - Logs expired sessions
  - `payment_intent.payment_failed` - Logs failed payments
- Fixed build issues by lazy-loading Amadeus and Supabase clients
- Successfully deployed to Vercel: `https://travel-bids-mschlosser22s-projects.vercel.app`

### 2. Configured Stripe Webhook Endpoint ✅
- Webhook URL: `https://travel-bids-mschlosser22s-projects.vercel.app/api/webhooks/stripe`
- Registered in Stripe Dashboard
- Selected events: `checkout.session.completed`, `checkout.session.expired`, `payment_intent.payment_failed`
- API Version: `2025-11-17.clover`
- Added `STRIPE_WEBHOOK_SECRET` to Vercel environment variables
- Redeployed after adding env var

### 3. Created Test Booking in Database ✅
- Booking ID: `d767f758-4af5-4ab1-be33-5b6f33b9599e`
- Hotel: "Test Hotel - Stripe Webhook Test"
- Guest: test@example.com
- Total: $250.00
- Status: "pending"
- Check-in: 2025-02-01
- Check-out: 2025-02-03

## What We Need To Do Next

### 4. Test the Webhook (IN PROGRESS)
Since Vercel deployment has authentication enabled, we couldn't create a Stripe checkout session via API.

**Next Steps:**
1. Use Stripe Dashboard to send a test webhook event:
   - Go to https://dashboard.stripe.com/webhooks
   - Click on the webhook endpoint
   - Click "Send test event"
   - Select `checkout.session.completed`
   - Manually add metadata: `{"bookingId": "d767f758-4af5-4ab1-be33-5b6f33b9599e"}`
   - Send the event

2. Verify the webhook worked:
   - Check Stripe webhook logs to see if request succeeded
   - Query Supabase to verify booking status changed from "pending" to "confirmed"
   - Check that `stripe_payment_intent_id` and `stripe_payment_status` were updated

### 5. Alternative: Use Playwright MCP Server
Once Playwright MCP is added, we can:
1. Navigate to the booking page in browser
2. Click "Pay Now" to create real Stripe checkout session
3. Complete test payment in Stripe's test mode
4. Verify webhook fires automatically
5. Check booking status updates

## Important Files
- Webhook handler: `/app/api/webhooks/stripe/route.ts`
- Payment API: `/app/api/payments/create-checkout-session/route.ts`
- Booking page: `/app/booking/[bookingId]/page.tsx`
- Booking form: `/app/book/[hotelId]/[roomId]/BookingForm.tsx`

## Environment Variables Needed
- `STRIPE_SECRET_KEY` ✅
- `STRIPE_WEBHOOK_SECRET` ✅
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` (for client-side)
- `NEXT_PUBLIC_APP_URL` (for redirect URLs)

## Database Schema
```sql
bookings table:
- id (uuid)
- status (text) - 'pending', 'confirmed', 'cancelled'
- stripe_payment_intent_id (text)
- stripe_payment_status (text)
- guest_email (text)
- total_price (numeric)
- booking_metadata (jsonb)
- ... other fields
```
